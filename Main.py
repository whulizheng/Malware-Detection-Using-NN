import Preprocessor
import Utils
import Classifier_FCN
from sklearn import preprocessing

import numpy as np

target_path = "C:\\Users\\WhuLi\\Documents\\Infected\\theZoo-master\\malwares\\test\\"


if __name__ == "__main__":
    config = Utils.readjson("config.json")
    Transformer = Preprocessor.Transformer(
        config["advanced"]["img_width"], config["advanced"]["img_height"])
    Classifier = Classifier_FCN.Classifier_FCN(
        config["advanced"]["input_shape"],
        config["model"]["nb_classes"],
        config["model"]["model_path"]
    )
    test_targets = Utils.scan_file(target_path)[0]

    enc = preprocessing.OneHotEncoder()
    enc.fit(np.array(range(config["model"]["nb_classes"])).reshape(-1, 1))
    Classifier.load_model("model/best_model.hdf5")

    for files in test_targets:
        matrix = Transformer.Load_file(target_path+files)
        img = Transformer.transform(matrix)
        img.show(title=files)
        img = np.array(img).reshape(
            (config["advanced"]["img_width"], config["advanced"]["img_height"], 1))
        ans = Classifier.predict(img.reshape(
            (1, config["advanced"]["img_width"],
             config["advanced"]["img_height"], 1)))[0]
        if ans == 0:
            print(files+"被识别为普通文件")
        elif ans == 1:
            print(files+"被识别为恶意文件")
        else:
            print("无法确定"+files)
